---
# ============================================
# AGENTGATEWAY RESOURCES FOR kagent-grafana-mcp
# Routes the existing RemoteMCPServer through
# AgentGateways for governance compliance
# Two paths: /mcp/grafana/ro (read-only) and /mcp/grafana/rw (read-write)
# ============================================

# AgentgatewayBackend for read-only operations
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: kagent-grafana-mcp-backend-ro
  namespace: kagent
spec:
  mcp:
    targets:
      - name: kagent-grafana-mcp
        static:
          host: kagent-grafana-mcp.kagent.svc.cluster.local
          port: 8000
          path: /mcp
          protocol: StreamableHTTP
  policies:
    tls:
      sni: kagent-grafana-mcp.kagent.svc.cluster.local

---
# AgentgatewayBackend for read-write operations
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: kagent-grafana-mcp-backend-rw
  namespace: kagent
spec:
  mcp:
    targets:
      - name: kagent-grafana-mcp
        static:
          host: kagent-grafana-mcp.kagent.svc.cluster.local
          port: 8000
          path: /mcp
          protocol: StreamableHTTP
  policies:
    tls:
      sni: kagent-grafana-mcp.kagent.svc.cluster.local

---
# HTTPRoute routing /mcp/grafana/ro and /mcp/grafana/rw traffic through respective backends
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: kagent-grafana-mcp-route
  namespace: kagent
spec:
  parentRefs:
    - name: kagent-mcp-gateway
  rules:
    # Read-only path
    - matches:
        - path:
            type: PathPrefix
            value: /mcp/grafana/ro
      backendRefs:
        - group: agentgateway.dev
          kind: AgentgatewayBackend
          name: kagent-grafana-mcp-backend-ro
    # Read-write path
    - matches:
        - path:
            type: PathPrefix
            value: /mcp/grafana/rw
      backendRefs:
        - group: agentgateway.dev
          kind: AgentgatewayBackend
          name: kagent-grafana-mcp-backend-rw

---
# AgentgatewayPolicy for read-only path - 10 read-only tools
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: kagent-grafana-mcp-access-policy-ro
  namespace: kagent
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: kagent-grafana-mcp-route
  traffic:
    # JWT Authentication
    jwtAuthentication:
      mode: Strict
      providers:
        - issuer: https://auth.mcp-governance.io
          audiences:
            - mcp-agents
            - kagent-grafana-ro
          jwks:
            inline: '{"keys":[{"kty":"RSA","use":"sig","kid":"mcp-governance-key-1","n":"0vx7agoebGcQSuuPiLJXZptN9nndrQmbXEps2aiAFbWhM78LhWx4cbbfAAtVT86zwu1RK7aPFFxuhDR1L6tSoc_BJECPebWKRXjBZCiFV4n3oknjhMstn64tZ_2W-5JsGY4Hc5n9yBXArwl93lqt7_RN5w6Cf0h4QyQ5v-65YGjQR0_FDW2QvzqY368QQMicAtaSqzs8KJZgnYb9c7d0zgdAZHzu6qMQvRL5hajrn1n91CbOpbISD08qNLyrdkt-bFTWhAI4vMQFh6WeZu0fM4lFd2NcRwr3XPksINHaQ-G_xBniIqbw0Ls1jF44-csFCur-kEgU8awapJzKnqDKgw","e":"AQAB"}]}'
    # CORS Policy
    cors:
      allowOrigins:
        - "https://dashboard.mcp-governance.io"
      allowMethods:
        - GET
        - OPTIONS
      allowHeaders:
        - Authorization
        - Content-Type
        - X-MCP-Session-Id
      exposeHeaders:
        - X-MCP-Request-Id
      maxAge: 3600
      allowCredentials: true
    # CSRF Protection
    csrf:
      additionalOrigins:
        - "https://dashboard.mcp-governance.io"
    # Rate Limiting (local) - stricter for read-only
    rateLimit:
      local:
        - unit: Minutes
          requests: 200
          burst: 50
    # Authorization - Allow only 10 read-only Grafana tools
    authorization:
      action: Allow
      policy:
        matchExpressions:
          - "mcp.tool.name in ['get_dashboard_by_uid', 'get_dashboard_summary', 'search_dashboards', 'list_datasources', 'query_prometheus', 'query_loki_logs', 'list_alert_rules', 'get_annotations', 'list_incidents', 'get_panel_image']"
  # Prompt Guard - Block prompt injection and mask sensitive data
  backend:
    ai:
      promptGuard:
        request:
          - response:
              message: "Blocked: Prompt injection or sensitive content detected"
            regex:
              action: Reject
              matches:
                - "ignore previous instructions"
                - "system prompt"
                - "jailbreak"
              builtins:
                - CreditCard
                - Ssn
        response:
          - regex:
              action: Mask
              builtins:
                - CreditCard
                - Ssn
                - Email

---
# AgentgatewayPolicy for read-write path - 10 read-write tools
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: kagent-grafana-mcp-access-policy-rw
  namespace: kagent
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: kagent-grafana-mcp-route
  traffic:
    # JWT Authentication
    jwtAuthentication:
      mode: Strict
      providers:
        - issuer: https://auth.mcp-governance.io
          audiences:
            - mcp-agents
            - kagent-grafana-rw
          jwks:
            inline: '{"keys":[{"kty":"RSA","use":"sig","kid":"mcp-governance-key-1","n":"0vx7agoebGcQSuuPiLJXZptN9nndrQmbXEps2aiAFbWhM78LhWx4cbbfAAtVT86zwu1RK7aPFFxuhDR1L6tSoc_BJECPebWKRXjBZCiFV4n3oknjhMstn64tZ_2W-5JsGY4Hc5n9yBXArwl93lqt7_RN5w6Cf0h4QyQ5v-65YGjQR0_FDW2QvzqY368QQMicAtaSqzs8KJZgnYb9c7d0zgdAZHzu6qMQvRL5hajrn1n91CbOpbISD08qNLyrdkt-bFTWhAI4vMQFh6WeZu0fM4lFd2NcRwr3XPksINHaQ-G_xBniIqbw0Ls1jF44-csFCur-kEgU8awapJzKnqDKgw","e":"AQAB"}]}'
    # CORS Policy
    cors:
      allowOrigins:
        - "https://dashboard.mcp-governance.io"
      allowMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowHeaders:
        - Authorization
        - Content-Type
        - X-MCP-Session-Id
      exposeHeaders:
        - X-MCP-Request-Id
      maxAge: 3600
      allowCredentials: true
    # CSRF Protection
    csrf:
      additionalOrigins:
        - "https://dashboard.mcp-governance.io"
    # Rate Limiting (local) - stricter for write operations
    rateLimit:
      local:
        - unit: Minutes
          requests: 60
          burst: 15
    # Authorization - Allow 10 read-write Grafana tools
    authorization:
      action: Allow
      policy:
        matchExpressions:
          - "mcp.tool.name in ['create_dashboard', 'update_dashboard', 'delete_dashboard', 'add_datasource', 'update_datasource', 'create_alert_rule', 'update_alert_rule', 'create_annotation', 'update_annotation', 'add_incident']"
  # Prompt Guard - Block prompt injection and mask sensitive data
  backend:
    ai:
      promptGuard:
        request:
          - response:
              message: "Blocked: Prompt injection or sensitive content detected"
            regex:
              action: Reject
              matches:
                - "ignore previous instructions"
                - "system prompt"
                - "jailbreak"
                - "drop table"
                - "delete from"
              builtins:
                - CreditCard
                - Ssn
        response:
          - regex:
              action: Mask
              builtins:
                - CreditCard
                - Ssn
                - Email
                - ApiKey
