---
# ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mcp-governance-controller
  namespace: mcp-governance
  labels:
    app.kubernetes.io/name: mcp-governance
    app.kubernetes.io/component: controller
---
# ClusterRole - read agentgateway, kagent, gateway API resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mcp-governance-controller
  labels:
    app.kubernetes.io/name: mcp-governance
rules:
  # agentgateway CRDs
  - apiGroups: ["agentgateway.dev"]
    resources:
      - agentgatewaybackends
      - agentgatewayparameters
      - agentgatewaypolicies
    verbs: ["get", "list", "watch"]
  # Gateway API resources
  - apiGroups: ["gateway.networking.k8s.io"]
    resources:
      - gateways
      - httproutes
      - gatewayclasses
    verbs: ["get", "list", "watch"]
  # kagent CRDs
  - apiGroups: ["kagent.dev"]
    resources:
      - agents
      - mcpservers
      - remotemcpservers
    verbs: ["get", "list", "watch"]
  # Governance CRDs
  - apiGroups: ["governance.mcp.io"]
    resources:
      - mcpgovernancepolicies
      - governanceevaluations
      - governanceevaluations/status
    verbs: ["get", "list", "watch", "create", "update", "patch"]
  # Core resources for service discovery
  - apiGroups: [""]
    resources:
      - services
      - namespaces
      - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources:
      - deployments
    verbs: ["get", "list", "watch"]
---
# ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mcp-governance-controller
  labels:
    app.kubernetes.io/name: mcp-governance
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: mcp-governance-controller
subjects:
  - kind: ServiceAccount
    name: mcp-governance-controller
    namespace: mcp-governance
---
# Controller + API Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-governance-controller
  namespace: mcp-governance
  labels:
    app.kubernetes.io/name: mcp-governance
    app.kubernetes.io/component: controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mcp-governance
      app.kubernetes.io/component: controller
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mcp-governance
        app.kubernetes.io/component: controller
    spec:
      serviceAccountName: mcp-governance-controller
      containers:
        - name: controller
          image: localhost/mcp-governance-controller:latest
          imagePullPolicy: Never
          ports:
            - name: api
              containerPort: 8090
              protocol: TCP
          env:
            - name: PORT
              value: "8090"
          livenessProbe:
            httpGet:
              path: /api/health
              port: api
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/health
              port: api
            initialDelaySeconds: 3
            periodSeconds: 5
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
---
# Controller Service
apiVersion: v1
kind: Service
metadata:
  name: mcp-governance-controller
  namespace: mcp-governance
  labels:
    app.kubernetes.io/name: mcp-governance
    app.kubernetes.io/component: controller
spec:
  selector:
    app.kubernetes.io/name: mcp-governance
    app.kubernetes.io/component: controller
  ports:
    - name: api
      port: 8090
      targetPort: api
      protocol: TCP
---
# Dashboard Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-governance-dashboard
  namespace: mcp-governance
  labels:
    app.kubernetes.io/name: mcp-governance
    app.kubernetes.io/component: dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mcp-governance
      app.kubernetes.io/component: dashboard
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mcp-governance
        app.kubernetes.io/component: dashboard
    spec:
      containers:
        - name: dashboard
          image: localhost/mcp-governance-dashboard:latest
          imagePullPolicy: Never
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          env:
            - name: CONTROLLER_API_URL
              value: "http://mcp-governance-controller.mcp-governance.svc.cluster.local:8090"
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
---
# Dashboard Service (NodePort for Kind access)
apiVersion: v1
kind: Service
metadata:
  name: mcp-governance-dashboard
  namespace: mcp-governance
  labels:
    app.kubernetes.io/name: mcp-governance
    app.kubernetes.io/component: dashboard
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: mcp-governance
    app.kubernetes.io/component: dashboard
  ports:
    - name: http
      port: 3000
      targetPort: http
      nodePort: 30000
      protocol: TCP
